#!/usr/bin/env bash

set -eo pipefail

mkdir -p tmp/

cd tmp
rm -rf test_tmpl

rails new test_tmpl -m ../template.rb

cd test_tmpl

echo " => Verify CircleCI config:"
circleci config validate

echo " => Verify installation scripts:"
bin/tools-setup
bin/tools-upgrade

echo " => Verify linters setup:"

git add .
git commit -m 'Initial Commit'

echo " => class SampleForLinters;end" > sample_for_linters.rb

git checkout -b test_pr
git add .
git commit -m 'Adds sample_for_linters'

bin/rubocop --fail-level F sample_for_linters.rb
bin/pronto run -c HEAD~1 --no-exit-code

cd ..
rm -rf test_tmpl_pronto
git clone -l test_tmpl test_tmpl_pronto
cd test_tmpl_pronto
bin/lint-github-pr -f text

echo " => Run git hooks verifications"
bin/git-hooks/post-merge
bin/git-hooks/pre-push
